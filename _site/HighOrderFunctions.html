
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>High-order functions. &#8212; dotty-cps-async 0.9.2 documentation</title>
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../index.html">dotty-cps-async 0.9.2 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">High-order functions.</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="high-order-functions">
<h1>High-order functions.<a class="headerlink" href="#high-order-functions" title="Permalink to this headline">¶</a></h1>
<p>Dotty-cps-async supports the automatic transformation of high-order functions,  where the lambda expression argument contains <code class="docutils literal notranslate"><span class="pre">await</span></code>.</p>
<p>Example – let us have a list of remote servers and want to fetch some data from each of them.
Assume, that out http client provides next interface:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">trait</span> <span class="nc">HttpClient</span><span class="k">:</span>
   <span class="kt">def</span> <span class="kt">fetchData</span><span class="o">(</span><span class="kt">url:</span> <span class="kt">String</span><span class="o">)</span><span class="kt">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>
</pre></div>
</div>
<p>Then we can fetch data from all servers just by using <code class="docutils literal notranslate"><span class="pre">await</span></code> in the <code class="docutils literal notranslate"><span class="pre">map</span></code> argument:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">urls</span><span class="o">.</span><span class="n">map</span><span class="o">(</span> <span class="n">await</span><span class="o">(</span><span class="n">httpClient</span><span class="o">.</span><span class="n">fetchData</span><span class="o">(</span><span class="k">_</span><span class="o">))</span> <span class="o">)</span>
</pre></div>
</div>
<p>Note that the default <code class="docutils literal notranslate"><span class="pre">map</span></code> will run all operations sequentially. Sequential order of evaluation is needed to allow the code, like updating the multidimensional array in for loop, works correctly in an asynchronous case.</p>
<p>If we want all requests to run in parallel, we can start them in one map and when all started - wait for the end of requests:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">urls</span><span class="o">.</span><span class="n">map</span><span class="o">(</span> <span class="n">httpClient</span><span class="o">.</span><span class="n">fetchData</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">await</span><span class="o">(</span><span class="k">_</span><span class="o">))</span>
</pre></div>
</div>
<dl class="simple">
<dt>During async transform, dotty-cps-async substitute method map of you List with signature</dt><dd><p><code class="docutils literal notranslate"><span class="pre">List[A].map[B](f:</span> <span class="pre">A=&gt;B)</span></code> to</p>
</dd>
</dl>
<p>:: index:: AsyncShift</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">summon</span><span class="o">[</span><span class="kt">AsyncShift</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">A</span><span class="o">]]].</span><span class="n">map</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="p">,</span><span class="kt">B</span><span class="o">](</span><span class="n">c</span><span class="o">,</span><span class="n">summon</span><span class="o">[</span><span class="kt">CpsMonad</span><span class="o">[</span><span class="kt">F</span><span class="o">]])</span>
</pre></div>
</div>
<p>which is implemented in cps runtime with signature</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="nc">AsyncShift</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">A</span><span class="o">]].</span><span class="n">map</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="p">,</span><span class="kt">B</span><span class="o">](</span><span class="n">obj</span><span class="k">:</span><span class="kt">List</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span><span class="n">cpsMonad</span><span class="k">:</span><span class="kt">CpsMonad</span><span class="o">[</span><span class="kt">F</span><span class="o">])(</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span><span class="o">=&gt;</span> <span class="n">F</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span>
</pre></div>
</div>
<p>Dotty-cps-async includes implementations of shifted methods for most of the standard library objects. So, it is possible to write something like <code class="docutils literal notranslate"><span class="pre">x=cache.getOrElse(</span> <span class="pre">await(fetchData()</span> <span class="pre">)</span></code> .</p>
<div class="section" id="providing-shifted-functions">
<h2>Providing shifted functions.<a class="headerlink" href="#providing-shifted-functions" title="Permalink to this headline">¶</a></h2>
<div class="section" id="functional-interface">
<h3>Functional interface.<a class="headerlink" href="#functional-interface" title="Permalink to this headline">¶</a></h3>
<p>Suppose you want to make high-order methods of your class <code class="docutils literal notranslate"><span class="pre">C</span></code> be able to accept lambda functions with await.
In that case, you should implement <code class="docutils literal notranslate"><span class="pre">given</span> <span class="pre">AsynsShift[C]</span></code> typeclass with a shifted version of your high-order methods.
Such a ‘shifted’ version has an additional type parameter: <code class="docutils literal notranslate"><span class="pre">F[_]</span></code>  and an additional list of arguments, inserted first, which contains the original object instance and an appropriative <code class="docutils literal notranslate"><span class="pre">CpsMonad[F]</span></code>.</p>
<p>Parameters should be changed in the following way:</p>
<ul class="simple">
<li><p>If the origin parameter has type  <code class="docutils literal notranslate"><span class="pre">A=&gt;B</span></code>, then changed: <code class="docutils literal notranslate"><span class="pre">A</span> <span class="pre">=&gt;</span> <span class="pre">F[B]</span></code></p></li>
<li><p>If the origin parameter is called by name with type <code class="docutils literal notranslate"><span class="pre">=&gt;A</span></code>, then changed: <code class="docutils literal notranslate"><span class="pre">()=&gt;F[A]</span></code></p></li>
<li><p>Otherwise, the changed parameter has the same type as the origin.</p></li>
</ul>
<p>Example:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span> <span class="k">class</span> <span class="nc">TaggedValue</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">tag</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span>  <span class="kt">T</span><span class="o">)</span>
     <span class="k">def</span>   <span class="n">modified</span><span class="o">[</span><span class="kt">S</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">T</span> <span class="o">=&gt;</span> <span class="n">S</span><span class="o">)</span><span class="k">:</span> <span class="kt">TaggedValue</span><span class="o">[</span><span class="kt">S</span><span class="o">]</span> <span class="k">=</span>
         <span class="nc">TaggedValue</span><span class="o">(</span><span class="n">tag</span><span class="o">,</span> <span class="n">f</span><span class="o">(</span><span class="n">x</span><span class="o">))</span>

<span class="k">class</span> <span class="nc">TaggedValueAsyncShift</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">extends</span> <span class="nc">AsyncShift</span><span class="o">[</span><span class="kt">TaggedValue</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span><span class="k">:</span>

     <span class="kt">def</span> <span class="kt">modified</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="p">,</span><span class="kt">S</span><span class="o">](</span><span class="n">o</span><span class="k">:</span><span class="kt">TaggedValue</span><span class="o">[</span><span class="kt">T</span><span class="o">],</span> <span class="n">m</span><span class="k">:</span> <span class="kt">CpsMonad</span><span class="o">[</span><span class="kt">F</span><span class="o">])(</span><span class="n">f</span><span class="k">:</span> <span class="kt">T</span><span class="o">=&gt;</span><span class="n">F</span><span class="o">[</span><span class="kt">S</span><span class="o">])</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">TaggedValue</span><span class="o">[</span><span class="kt">S</span><span class="o">]]</span> <span class="k">=</span>
         <span class="n">f</span><span class="o">(</span><span class="n">value</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="nc">TaggedValue</span><span class="o">(</span><span class="n">tag</span><span class="o">,</span><span class="k">_</span><span class="o">))</span>

<span class="k">object</span> <span class="nc">TaggedValue</span><span class="k">:</span>

     <span class="kt">transparent</span> <span class="kt">inline</span> <span class="kt">given</span> <span class="kt">shiftedTaggedValue</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="n">as</span> <span class="nc">AsyncShift</span><span class="o">[</span><span class="kt">TaggedValue</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="kt">=</span>
                                                                              <span class="kt">TaggedValueAsyncShift</span><span class="o">[</span><span class="kt">T</span><span class="o">]()</span>
</pre></div>
</div>
</div>
<div class="section" id="object-oriented-interface">
<h3>Object oriented interface<a class="headerlink" href="#object-oriented-interface" title="Permalink to this headline">¶</a></h3>
<p id="index-0">Sometimes, we can use classes, defines in the object-oriented manner, where data is private inside class.  If the developer of such class wants to provide API for dotty-cps-async, then he/she can do this without breaking encapsulation. What is needed - to implement AsyncShifted[F:CpsMonad] version inside  you class, which will accept methods with shifted parameters, and made a given ObjectAsync which should create instance of AsyncShifted from object and CpsMonad.</p>
<p>Example:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span>  <span class="nc">MyIntController</span><span class="k">:</span>
   <span class="kt">private</span> <span class="kt">var</span> <span class="kt">x:</span>  <span class="kt">Int</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

   <span class="k">def</span>  <span class="n">modify</span><span class="o">(</span><span class="n">f</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=&gt;</span> <span class="nc">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span>
      <span class="k">val</span> <span class="n">old</span> <span class="k">=</span> <span class="n">x</span>
      <span class="n">x</span> <span class="k">=</span> <span class="n">f</span><span class="o">(</span><span class="n">x</span><span class="o">)</span>
      <span class="n">sendSignal</span><span class="o">(</span><span class="n">x</span><span class="o">)</span>
      <span class="n">old</span>

   <span class="k">def</span> <span class="n">shifted</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="n">m</span><span class="k">:</span> <span class="kt">CpsMonad</span><span class="o">[</span><span class="kt">M</span><span class="o">])</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">MyIntControllerAsyncShifted</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span>

   <span class="k">class</span>  <span class="nc">MyIntControllerAsyncShifted</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="n">m</span><span class="k">:</span> <span class="kt">CpsMonad</span><span class="o">[</span><span class="kt">M</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">AsyncShifted</span><span class="o">[</span><span class="kt">MyIntController</span><span class="p">,</span><span class="kt">F</span><span class="o">]</span><span class="k">:</span>

         <span class="kt">def</span> <span class="kt">modify</span><span class="o">(</span><span class="kt">f:</span>  <span class="kt">Int</span> <span class="o">=&gt;</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Int</span><span class="o">])</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span>
              <span class="k">val</span> <span class="n">old</span> <span class="k">=</span> <span class="n">x</span>
              <span class="n">m</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">f</span><span class="o">(</span><span class="n">x</span><span class="o">))(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="o">{</span> <span class="n">sendSignal</span><span class="o">(</span><span class="n">x</span><span class="o">);</span> <span class="n">old</span> <span class="o">})</span>
</pre></div>
</div>
<p>Then we can define given instance for conversion:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">object</span> <span class="nc">MyIntController</span><span class="k">:</span>

  <span class="kt">class</span> <span class="kt">MyAsyncShift</span> <span class="kt">extends</span> <span class="kt">ObjectAsyncShift</span><span class="o">[</span><span class="kt">MyIntController</span><span class="o">]</span><span class="k">:</span>
         <span class="kt">def</span> <span class="kt">apply</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="n">obj</span><span class="k">:</span><span class="kt">MyIntController</span><span class="o">,</span> <span class="n">cpsMonad</span><span class="k">:</span> <span class="kt">CpsMonad</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span><span class="k">:</span><span class="kt">obj.InternalAsyncShifted</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="k">=</span>
                                                                                <span class="n">obj</span><span class="o">.</span><span class="n">shifted</span><span class="o">(</span><span class="n">cpsMonad</span><span class="o">)</span>

  <span class="n">transparent</span> <span class="n">inline</span> <span class="n">given</span> <span class="n">myAsyncShift</span> <span class="n">as</span> <span class="nc">ObjectAsyncShift</span><span class="o">[</span><span class="kt">Zzz</span><span class="o">]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">MyAsyncShift</span><span class="o">()</span>
</pre></div>
</div>
<dl class="simple">
<dt>Note that you should carefully decide whether you need async function support and how to deal with concurrent modifications.  For example, in the code snippet below, different changes will interleave with each other.</dt><dd><p>Usually, low-level constructs do not need async counterparts.</p>
</dd>
</dl>
</div>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">High-order functions.</a><ul>
<li><a class="reference internal" href="#providing-shifted-functions">Providing shifted functions.</a><ul>
<li><a class="reference internal" href="#functional-interface">Functional interface.</a></li>
<li><a class="reference internal" href="#object-oriented-interface">Object oriented interface</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/_site/HighOrderFunctions.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../index.html">dotty-cps-async 0.9.2 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">High-order functions.</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020-2021, Ruslan Shevchenko.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.2.1.
    </div>
  </body>
</html>